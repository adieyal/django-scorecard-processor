{% extends 'base.html' %}
{% load i18n %}
{% block head_title %}Response to {{survey.name}} for {{entity.name}}{% endblock %}
{% block script_bottom %}
{{block.super}}
<style>
  .legend.span5 {clear:left}
  .fields.span10 {float:right}
  label .identifier {margin-right:0.5em;}
  .form-stacked .clearfix div.input {clear:left;padding:5px 0 20px 20px}
  .input .currency {margin-right:0.5em;}
  select.currency_select {display:none}
  label abbr {font-weight:bold;border-bottom:dotted 1px #386; color:#386;cursor:help}
  #definitions {position:fixed;margin-top:40px;display:none}
  #definitions .term {display:none}
</style>
<script type="text/javascript">
$('.actions').hide();
$('ul.tabs').tabs();
$('ul.tabs').bind('change', function (e) {
  //window.console.log() // activated tab
  var href=$(e.target).attr('href');
  $('#next').attr('value',href.substring(1));
  if ($(e.target).parent().attr('id')=='intro_tab') {
    $('.actions').hide();
  } else {
    $('.actions').show();
  }
  parse_defs();
})
$('#continue_button').bind('click', function(e) {
  $($('.tabs li a')[1]).click();
  e.preventDefault();
})

next = false;
if (window.location.hash) {next = window.location.hash;}
if ($('.error').length) {
  next = '#'+$($('.error')[0]).parents('div.tab-pane').attr('id');
}

if (next) {
  $('a',next.replace('#','#t')).click();
}

var terms = Array();
$('.term').each(function (i,e) {
  terms.push({term:$(e).attr('data-term'), id:$(e).attr('id')})
})

function parse_defs() {
  var pane = $('.tab-pane.active')
  if (pane.data('parsed_def')==undefined) {
    $('label', pane).each(function(i,e) {
      $(terms).each(function(j,f) {
        var test = $(e).html().split(f.term);
        if (test.length > 1) {
          $(e).html(test.join("<abbr data-id='"+f.id+"'>"+f.term+"</abbr>"));
          //Do we want to keep finding more defs?
          return false;
        }
      });
    });
    pane.data('parsed_def',true);
  }
}

$('abbr').live({ 
  mouseover:function(e) {
    $('#definitions').fadeIn('fast');
    $('#'+$(this).data('id')).slideDown('fast');
  },
  mouseout:function(e){
    $('#definitions').fadeOut('fast');
    $('#'+$(this).data('id')).slideUp('fast');
  }
})

parse_defs();

</script>
{% endblock %}

{% block fluid_content_outer %}
  <div class="container">
    <div class="content">
      <div class="page-header">
        <h1>{{survey.name}} <small>for <a href="{{entity.get_absolute_url}}">{{entity.name}}</a> - {{data_series}}</small></h1>
      </div>
      <form method="POST" class="form-stacked">
          {% csrf_token %}
          <div class="row">
            <div class="span12">
              <ul class="tabs">
                <li class="active" id="intro_tab"><a href="#intro">Overview</a></li>
                {% for group in survey.questiongroup_set.all %}
                  <li id="tqg_{{group.pk|slugify}}"><a href="#qg_{{group.pk|slugify}}">{{forloop.counter}}</a></li>
                {% endfor %}
              </ul>
              <div class="form tab-content">
                <div class="tab-pane active" id="intro">
                  <p>{{survey.description|safe}}</p>
                  <div class="row">
                    <div class="span4">
                      <label>{{form.currency.label}}</label>
                      {{form.currency}}
                    </div>

                    <div class="span4">
                      <label>{{form.baseline_year.label}}</label>
                      {{form.baseline_year}}
                    </div>

                    <div class="span4">
                      <label>{{form.current_year.label}}</label>
                      {{form.current_year}}
                    </div>
                  </div>
                  <button class="btn primary large pull-right" id="continue_button" style="margin-top:30px">{% blocktrans %}Continue{%endblocktrans%}</button>
                </div>
                {{form.as_div}}
              </div>
              <input type="hidden" id="next" name="next" value="" />
              <div class="actions" style="display:none">
                  <button type="submit" class="pull-right btn primary large" name="button">{% blocktrans %}Save and continue{% endblocktrans %}</button> &nbsp;
              </div>
            </div>
            <div id="definitions" class="offset10 span6 well">
                {% for term in entity.project.get_glossary %}
                  <div class='term' id="{{term.term|slugify}}" data-term="{{term.term}}">
                    <p>{{term.definition.definition|safe}}</p>
                  </div>
                {% endfor %}
            </div>
            
          </div>
      </form>
    </div>
  </div>
{% endblock %}
